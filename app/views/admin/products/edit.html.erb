<!--side-->
<div id="main" class="right">
  <div class="main-title">
    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td valign="top" class="title" height="22" width="98"><%= DateTime.now.to_date %></td>
        <td valign="middle" class="text"><input id="product_title" type="text" /></td>
      </tr>
    </table>
  </div>
  <div class="main-title">
    <%= form_for(@product, :url => admin_productclass_product_path(params[:productclass_id], @product, :locale => I18n.locale), :method => "put") do |f| %> 

    <table width="100%" border="0" cellspacing="0" cellpadding="0">
      <tr>
        <td valign="middle" class="text"><input type="checkbox" id="productFrontshow" />在前台顯示</td>
      </tr>
    </table>
    
    <div style="display: none;">
    <%= f.label :name %>
    <%= f.text_field :name %>

    <%= f.text_field :status %>

    <input id="product_nameOrigin" type="text" value="">
    <%= f.label :content %>
    <%= f.text_field :content %>
    <input id="product_contentOrigin" type="text" value="">
    </div>
    <% end %>
   
  </div>

    

  <ul id="tab">
    <li data-name="paragraph"><a href="#main-text-p"><img src="/images/edit.png">插入段落</a></li>
    <li data-name="image"><a href="#main-text-img"><img src="/images/img.png"/>插入圖片</a></li>
  </ul>

  <div class="main-text">
    <div id="main-text-p">
       <select id="newParagraphFontSize" >
       	   <option value="" selected="selected">-- 大小 --</option>
	       <option value="14">14</option>
	       <option value="28">28</option>
       </select>
       <select id="newParagraphColor" >
       	   <option value="" selected="selected">-- 顏色 --</option>
	       <option value="#000">black</option>
	       <option value="#00F">blue</option>
       </select>
       <textarea id="newParagraphContent" class="autogrow" placeholder="請將段落輸入在此處"></textarea>
       <input type="text" id="newParagraphLink" placeholder="此段落連結至何處（若無請勿輸入）" />
    </div>
    <div id="main-text-img">
      <%= form_for (@photo), :url =>'uploadPhoto', :html => {:multipart => true, :remote => true} do |p| %>
      <%= p.file_field :image, :class => "autogrow" %>
      <div id="error"></div>
      <% end %>
    </div>
  </div>
  <div class="button" id="btnAddElement"><a href="#"><img src="/images/add.png">新增</a></div>


  <div id="tips">
    <h2>文章預覽</h2>
    <p> <img src="/images/tag.png"/>提示：將滑鼠移至段落內容，可進行拖曳排序以及修改刪除。</p>
  </div>

  <div class="main-preview">
    
    <!--show the content of article -->
    <div id="articleContent" class="sortable"></div>

    <div id='formerror'></div>

    <div class="buttonArea">
      <div class="button" id="btnSubmit"><a href="#"><img src="/images/save.png">儲存</a></div>
      <div class="button" id="btnCancel"><a href="#"><img src="/images/cancel.png">取消</a></div>
    </div>
    <!--main-text--> 
  </div>
  <!--main-->

<script type="text/javascript">
$(document).ready(function(){
  $("#productclasses").addClass("active");
});
</script>
<script src="http://code.jquery.com/ui/1.9.1/jquery-ui.js"></script>
<script type="text/javascript">
$(function(){
  $("#update").addClass("active");

  // 預設顯示第一個 Tab
  var _showTab = 0;
  var $defaultLi = $('#tab li').eq(_showTab).addClass('active');
  $($defaultLi.find('a').attr('href')).siblings().hide();
 
  // 當 li 頁籤被點擊時...
  // 若要改成滑鼠移到 li 頁籤就切換時, 把 click 改成 mouseover
  $('#tab li').click(function() {
    // 找出 li 中的超連結 href(#id)
    var $this = $(this),
      _clickTab = $this.find('a').attr('href');
    // 把目前點擊到的 li 頁籤加上 .active
    // 並把兄弟元素中有 .active 的都移除 class
    $this.addClass('active').siblings('.active').removeClass('active');
    // 淡入相對應的內容並隱藏兄弟元素,把.show()改成.hide()
    $(_clickTab).stop(false, true).fadeIn().siblings().hide();
 
    return false;
    }).find('a').focus(function(){
      this.blur();
  });
});
</script>

<script type="text/javascript">
  var form = "#edit_product_<%= params[:id]%>";

  $("#productFrontshow").change(function(){
    $("#product_status").val($(this).is(':checked')? "enable":"disable");
  });

  if($("#product_status").val()=="enable"){
    $("#productFrontshow").attr('checked', true);
  }

  //record the origin content
  $("#product_contentOrigin").val($("#product_content").val());
  $("#product_nameOrigin").val($("#product_name").val());
  $("#product_title").val($("#product_name").val());

  //show content
  showContent();

  $("#btnAddElement").click(function(event){
    var liList = $("#tab li");

    for(var arrayLength = liList.length, i = 0; i<arrayLength; i++){
      if($(liList[i]).hasClass("active")){
        switch($(liList[i]).data("name")){
          case "paragraph":
            addParagraph();
            break;
          case "image":
            addImage();
            break;
        }
        break;
      }
      
    }
    bindEdit();
    event.preventDefault();
    
  });

  function addParagraph(){
    if($("#newParagraphContent").val()){
    	var style = 'style="';
    	
    	if ($('#newParagraphFontSize').val().length > 0) {
	    	style += "font-size: " + $('#newParagraphFontSize').val() + "px; ";
    	}
    	
    	if ( $('#newParagraphColor').val().length > 0 ) {
	    	style += "color: " + $('#newParagraphColor').val() + "; ";	    	
    	}
    
    	style += '"';
    
      var container = $('<div class="paragraphContainer ui-state-default dragItem" data-type="paragraph">' +
      					'<div class="edit">' +
      					'<a name="edit">編輯</a><a name="delete">刪除</a>' +
      					'</div>' +
      					'</div>');
      
      var content = $("#newParagraphContent").val().replace(/\n/g, "<br />");
      								
      var paragraph = $('<p class="paragraph" ' + style + ' >' + content + "</p>");
      
      if ( $('#newParagraphLink').val().length > 0 ) {
      		var contentLink =  $('<a target="_blank" href="' + $('#newParagraphLink').val() + '"></a>').html(paragraph.html());
      		paragraph.html('');
      		paragraph.append(contentLink);
      }
      
      container.append(paragraph);

      $("#articleContent").append(container);
      $("#newParagraphContent").val('');

      saveArticle();
    }
    else{
      alert("請輸入內容");
    }
  }

  function addImage(){
    if($("#productphoto_image").val()){
      $("#new_productphoto").submit();
    }
    else{
      alert("請選擇要上傳的檔案");
    }
    
  }

  //validate image upload
  $("#new_productphoto").submit(function(){
    $("#error").html("");
      return formvalidate();
  });

  function formvalidate(){
    //validate image upload
    var isPass = false;
    var alert;

    var fileinput = document.getElementById('productphoto_image');
    if(fileinput.files[0]){
      var typeAllowed = ["gif", "png", "jpg", "jpeg"];

      (function() {
        outerloop:
        for(var item in typeAllowed){
          if(fileinput.files[0].type.indexOf(typeAllowed[item]) != -1){
            isPass = true;
            break outerloop;
          }
        }
      })();

      alert = isPass? null : "<p>只能上傳 .gif, .png, .jpg 圖片檔</p>";

      if(fileinput.files[0].size > 5 * 1024 *1024){
        isPass = false;
        alert += "<p>檔案大小必須小於5MB</p>";
      }
      if(!isPass){
        $("#error").append(alert);
        $(fileinput).val(""); 
        return false;
      }
    }
    return true;
  }

  function newImage(photoID,photoPath){
    $("#articleContent").append('<div class="paragraphContainer ui-state-default dragItem" data-type="image" data-photo_id="'+ photoID +'"><div class="edit"><a href="/admin/productclasses/<%= params[:productclass_id]%>/products/:product_id/deletePhoto/' + photoID + '" data-method="delete" rel="nofollow" data-remote="true">刪除</a></div><img src="'+photoPath+'" alt="'+photoID+'" /></div>');
    $('#new_photo').each (function(){
      this.reset();
    });

    saveArticle();    
  }

  /* paragraphs sortable */
  $( ".sortable" ).sortable({
    placeholder: "ui-state-highlight",
    disable: true,
    stop: function( event, ui ) {saveArticle();}
  });

  var editingFlag = false;
  bindEdit();
  function bindEdit(){
    /* edit or delete the paragraphs */
  $("div.edit a[name=edit]").click(function(event){
    if(!editingFlag){
      editingFlag = true;
      $(".buttonArea").hide();
      var paragraph = $(this).parent().next();

      $(this).parent().parent().append("<div id='editDiv'><textarea id='editedContent' rows='4' cols='50'></textarea><br /><label /><br /><input type='button' id='editFinish' value='完成修改'/><input type='button' id='editCancel' value='取消'/></div>");

      //avoid content in textbox can't not be editted due to the using of jquery sortable
      event.stopImmediatePropagation();

      var contentLink = $(paragraph).html().match(/^\<a([\S\s]+)href\=\"([\S\s]+)\"\>(.+)\<\/a\>/);
      
      if(contentLink){
        contentLink.aLink = contentLink[2];
        contentLink.aContent = br2nl(contentLink[3]);
      }

      $("#editedContent").html(contentLink? contentLink.aContent : br2nl($(paragraph).html()) );
      $("#editDiv label").html("連結網址：" + (contentLink? contentLink.aLink : "")).css("display", contentLink? "inline-block" : "none");

      $(paragraph).hide();

      $("#editFinish").click(function(){
        if($("#editedContent").val()){
          var content = (contentLink? '<a target="_blank" href="'+contentLink.aLink+'">': "" )+ nl2br($("#editedContent").val())+ (contentLink? '</a>': "");
          $(this).parent().prev().html(content).show();
          $("#editDiv").remove();
          saveArticle();
          editingFlag = false;
          $(".buttonArea").show();
        }
        else{
          $("#editedContent").val(br2nl($(paragraph).html()));
        }
      });

      $("#editCancel").click(function(){
        $(this).parent().prev().show();
        $("#editDiv").remove();
        editingFlag = false;
        $(".buttonArea").show();
      });
    }
  });

  $("div.edit a[name=delete]").click(function(){
    $(this).parent().parent().remove();
    saveArticle();
  });
  }

  /* save and update the article */
  function contentPack(){
    var article = "";
    var obj = new Object();
    obj.article = new Array();

    $("#articleContent .paragraphContainer").children().each(function(){
      if($(this).is("p")){
        var p = new Object();
        p.type = "paragraph";
        p.color = $(this).css('color');
        p.fontSize = $(this).css('font-size');
        
        if ( $(this).children('a').length > 0 ) {	        
	        p.link = $(this).children('a').attr('href');	        
	        p.content=$(this).children('a').html();
        } else {
        	p.content=$(this).html();	        
        }
        obj.article.push(p);
      }
      else if ($(this).is("img")){
        var img = new Object();
        img.type = "image";
        img.path = $(this).attr("src");
        img.id = $(this).attr("alt");
        obj.article.push(img);
      }
      else if ($(this).is("iframe")) {
        var video = new Object();
        video.type = "video";
        video.code = $(this).data("code");
        obj.article.push(video);
      }
    });

    article = JSON.stringify(obj);
    $("#product_content").val(article);
  }

  function saveArticle(){
    contentPack();

    $(form).ajaxSubmit({
      beforeSubmit: function(a,f,o) {
        o.dataType = 'json';
      },
      complete: function(XMLHttpRequest, textStatus) {
      }
    });
  }

  function showContent(){
    if($("#product_content").val())
    {
      try
      {
        var obj = JSON.parse($("#product_content").val());
        var article = "";
        for(i=0;i<obj.article.length;i++)
        {
          var paragraph = obj.article[i];

          if(JSON.stringify(paragraph.type)=='"paragraph"')
          {
            article = "<div class='paragraphContainer ui-state-default dragItem' data-type='paragraph'><div class='edit'><a name='edit'>編輯</a><a name='delete'>刪除</a></div><p style = ' font-size: "+paragraph.fontSize+"; color: "+paragraph.color+"'>";
            if(paragraph.link){
              article += "<a target='_blank' href='"+paragraph.link+"'>"+jsonReplace(JSON.stringify(paragraph.content)).replace(/\\n/g, "<br />")+"</a></p></div>";
            }
            else{
              article += jsonReplace(JSON.stringify(paragraph.content)).replace(/\\n/g, "<br />")+"</p></div>";
            }
          }
          else if(JSON.stringify(paragraph.type)=='"image"')
          {
            article = "<div  class='paragraphContainer ui-state-default dragItem' data-type='image' data-photo_id=\"" + paragraph.id + "\"><div class='edit'><a href='/admin/productclasses/<%= params[:productclass_id]%>/products/:product_id/deletePhoto/" + paragraph.id + "' data-method='delete' rel='nofollow' data-remote='true'>刪除</a></div><img alt=" + JSON.stringify(paragraph.id) + " src=" + JSON.stringify(paragraph.path) + " title=" + JSON.stringify(paragraph.id) + " /></div>";
          }

          $("#articleContent").append(article);
        }//end of for.}
      }
      catch( err )
      {
        $("#product_content").val("");
        saveArticle();
        $("#formerror").html("<p>文章內容錯誤, 請重新輸入</p>");
      }
      
    }//end of if.
  }

  function jsonReplace(string){return string.replace(/"([^"]*)"/g, "$1");}

  function nl2br(string) { return string.replace(/\n/g, "<br />");}
  function br2nl(string) { return string.replace(/<br[ \/]*>/g, "\n");}

  $("#btnSubmit").click(function(){
    $("#product_name").val($("#product_title").val());
    $(form).submit();
  });

  $("#btnCancel").click(function(){
    $("#product_content").val($("#product_contentOrigin").val());
    $("#product_name").val($("#product_nameOrigin").val());
    $(form).submit();
  });


  //validate when submit
  $(form).submit(function(){
    var submit = true;
    $("#formerror").html("");
    $("#product_frontshow").val("true");

    $(".validate").each(function(){
      if(!$(this).val()){
        submit = false;
      }
    });

    if(!submit){
      $("#formerror").append("<p>請輸入文章標題</p>");
    }

    return submit;
  });


</script>
